# YAML导出故障排除指南

## 🔍 问题分析：为什么YAML文件没有通过MCP工具生成？

### 用户报告的问题

用户使用以下请求时，YAML文件没有自动生成：
```
"你是一个资深的API分析师，现在你需要从华为云获取云应用服务的查询服务器组列表API的详细信息，并导出为YAML文件，导出路径为当前项目下的根目录。根据该YAML文件中记录的参数按照Terraform provider开发规范进行数据源开发"
```

### 🎯 根本原因分析

#### 1. **MCP工具参数检测机制问题**
- **症状**: API详情能够正常获取，但没有导出YAML文件
- **原因**: Cursor无法自动检测到用户需要YAML导出，没有设置`export_yaml=true`
- **具体分析**:
  - MCP工具的`export_yaml`参数默认为`false`
  - 原有工具描述中的"支持导出YAML文件"提示过于模糊
  - Cursor缺乏智能推断用户YAML导出意图的逻辑

#### 2. **工具描述优化不足**
- **问题**: 工具描述没有明确指导Cursor何时设置`export_yaml=true`
- **影响**: 即使用户明确提到"导出"、"YAML"、"文件"等关键词，Cursor也不会自动设置导出参数

#### 3. **输出目录处理缺失**
- **问题**: 用户指定"当前项目下的根目录"时，系统无法智能识别并转换为正确的路径
- **结果**: 即使触发了YAML导出，也可能输出到错误的位置

## ✅ 解决方案

### 1. **优化MCP工具描述**

#### 改进前：
```
"description": "获取华为云指定产品的API接口详细信息...支持导出为YAML文件。"
```

#### 改进后：
```
"description": "获取华为云指定产品的API接口详细信息...当用户提到'导出'、'YAML'、'文件'、'保存'、'下载'、'生成文件'时，自动设置export_yaml=true导出YAML文件。"
```

### 2. **增强参数智能检测**

#### 触发关键词列表：
- `导出` / `导出为` / `导出到`
- `YAML` / `yaml` / `YML` / `yml`
- `文件` / `生成文件` / `保存文件`
- `保存` / `下载` / `输出文件`
- `生成` / `创建文件` / `写入文件`

#### 参数描述优化：
```json
{
  "export_yaml": {
    "type": "boolean",
    "description": "是否导出为YAML文件。当用户明确提到'导出'、'YAML'、'文件'、'保存'、'下载'、'生成文件'、'导出为文件'、'输出文件'时设置为true，否则默认false"
  }
}
```

### 3. **智能输出目录处理**

#### 用户表述映射：
| 用户表述 | 智能识别 | 实际路径 |
|---------|---------|----------|
| "项目根目录" | ✅ | `.` |
| "当前项目下的根目录" | ✅ | `.` |
| "当前目录" | ✅ | `.` |
| "根目录" | ✅ | `.` |
| "项目下" | ✅ | `.` |
| 未指定 | ✅ | `api_exports/` |

#### 实现代码：
```python
# 智能处理输出目录
if output_dir in [".", "当前目录", "项目根目录", "根目录", "当前项目", "项目下", "项目目录"]:
    output_dir = "."
```

### 4. **改进响应信息**

#### 导出成功后的详细反馈：
```
📄 YAML文件已成功导出到: ./WorkspaceApp_ListServerGroups.yml
📍 完整路径: /home/user/project/WorkspaceApp_ListServerGroups.yml
✅ 已按要求导出到项目根目录
```

## 🧪 验证测试

### 测试用例1：基本导出功能
```bash
python3.10 -c "
import asyncio
from scan.cursor_optimized_server import CursorOptimizedMCPServer

async def test():
    server = CursorOptimizedMCPServer()
    result = await server._get_api_info({
        'product_name': '云应用',
        'interface_name': '查询服务器组列表',
        'export_yaml': True,
        'output_dir': '项目根目录'
    })
    print(result['content'][0]['text'])

asyncio.run(test())
"
```

### 测试用例2：验证文件生成
```bash
ls -la WorkspaceApp_ListServerGroups.yml
```

### 测试结果：
- ✅ API详细信息成功获取
- ✅ YAML文件成功导出到项目根目录
- ✅ 路径智能识别正常工作
- ✅ 详细反馈信息正确显示

## 🎯 使用建议

### 正确的请求方式：

#### ✅ 推荐请求格式：
```
获取华为云云应用服务的查询服务器组列表API详细信息，并导出为YAML文件到项目根目录
请导出华为云弹性云服务器的创建云服务器API详细信息为YAML文件
从华为云获取对象存储服务的上传对象API详细信息，保存为文件
生成华为云VPC的创建虚拟私有云API详细信息文件
```

#### ❌ 避免的表述：
```
获取华为云API信息（缺少导出关键词）
查询华为云服务详情（没有明确要求文件输出）
了解华为云产品信息（过于模糊）
```

### 输出目录指定：

#### ✅ 推荐表述：
```
导出到项目根目录
保存到当前目录
输出文件到项目下
导出路径为当前项目的根目录
```

#### ✅ 自定义目录：
```
导出到 ./api_docs 目录
保存到 /tmp/huawei_apis 文件夹
输出到 docs/apis 目录
```

## 📋 故障排查清单

### 如果YAML文件仍未生成：

1. **检查请求内容**：
   - [ ] 是否包含导出相关关键词？
   - [ ] 是否明确指定了产品名和接口名？
   - [ ] 是否使用了Cursor Agent模式？

2. **检查MCP连接**：
   - [ ] MCP服务器是否正常运行？
   - [ ] Cursor MCP配置是否正确？
   - [ ] 是否看到工具调用日志？

3. **检查文件系统**：
   - [ ] 输出目录是否有写入权限？
   - [ ] 磁盘空间是否充足？
   - [ ] 是否在正确的工作目录？

4. **检查错误信息**：
   - [ ] 查看Cursor的开发者工具控制台
   - [ ] 检查MCP服务器日志输出
   - [ ] 验证API响应是否包含错误信息

## 🔧 高级调试

### 手动测试MCP工具：
```bash
# 进入项目目录
cd ~/.local/share/api-scan

# 启动交互式测试
api-scan --test

# 选择选项3测试YAML导出功能
```

### 直接使用YAML导出工具：
```bash
# 导出API详细信息
api-scan --yaml --api-detail "云应用" "查询服务器组列表" --output-dir .

# 导出到指定目录
api-scan --yaml --api-detail "云应用" "查询服务器组列表" --output-dir ./api_exports
```

## 🎉 总结

通过以上优化，YAML导出功能现在能够：

1. **智能检测用户意图**：自动识别导出相关关键词
2. **智能处理输出目录**：正确理解用户指定的路径表述
3. **提供详细反馈**：明确显示文件生成位置和状态
4. **支持多种使用方式**：Agent模式自动调用 + 命令行手动操作

这些改进确保了用户的YAML导出需求能够被准确识别和执行，解决了原有的自动化识别问题。 